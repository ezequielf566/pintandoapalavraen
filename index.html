<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Pintando a Palavra â€” Colorir</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===== FIX 1: TELA FIXA (Prevenir scroll da pÃ¡gina inteira) ===== */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; /* Impede scroll do body */
      position: fixed; /* Evita bounce em iOS */
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh; /* Ocupa a altura real da tela */
      width: 100vw;
      overflow: hidden;
    }

    /* O Stage Ã© onde o SVG vive. Apenas ele permite interaÃ§Ã£o. */
    .stage {
      flex: 1;
      position: relative;
      overflow: hidden;
      touch-action: none; /* Crucial: Impede o navegador de arrastar a pÃ¡gina */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fdfdfd;
    }

    .svgMount {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== Estilo do Popup (Garantir transiÃ§Ã£o suave) ===== */
    .palette-popup {
      position: fixed; /* Mudar para fixed para facilitar cÃ¡lculo de viewport */
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }
    .palette-popup.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* ===== Loading Overlay ===== */
    #loadingOverlay{
      position:fixed;
      inset:0;
      background:#fff9e6;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:9999;
      transition:opacity .4s ease, visibility .4s ease;
    }
    #loadingOverlay.hidden{opacity:0;visibility:hidden}
    .spinner{
      width:60px;height:60px;
      border:6px solid #ffd54f;
      border-top:6px solid transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>ðŸŽ¨ Carregando ilustraÃ§Ãµes...</div>
</div>

<header class="topbar">
  <div id="progressWidget" class="progress-widget">
    <div class="counter">
      <span id="starCount">00</span>
      <span>/</span>
      <span id="totalPages">00</span>
      <span class="star-icon">â˜…</span>
      <span id="progressPercent">0%</span>
    </div>
    <div class="progressbar">
      <div class="track">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>
  </div>
</header>

<div class="app">
  <main class="stage">
    <div id="svgMount" class="svgMount"></div>
  </main>

  <footer class="controls">
    <div class="palette">
      <div class="swatches" id="swatches">
        <button class="sw" data-color="#E53935" style="--c:#E53935"></button>
        <button class="sw" data-color="#FB8C00" style="--c:#FB8C00"></button>
        <button class="sw" data-color="#FDD835" style="--c:#FDD835"></button>
        <button class="sw" data-color="#7CB342" style="--c:#7CB342"></button>
        <button class="sw" data-color="#42A5F5" style="--c:#42A5F5"></button>
        <button class="sw" data-color="#8E24AA" style="--c:#8E24AA"></button>
        <button class="sw" data-color="#E0C2A2" style="--c:#E0C2A2"></button>
        <button class="sw" data-color="#8D6E63" style="--c:#8D6E63"></button>

        <button class="sw custom-picker" id="pickerBtn">ðŸŽ¨</button>
        <input type="color" id="colorPickerInput" style="display:none">
        <button class="sw custom" id="customColorBtn">+</button>
      </div>
    </div>

    <div class="tools">
      <button id="eraserBtn" class="btn">Borracha</button>
      <button id="undoBtn" class="btn">Desfazer</button>
      <button id="redoBtn" class="btn">Refazer</button>
      <button id="savePng" class="btn primary">Salvar</button>
    </div>

    <div class="pager">
      <button id="prevBtn" class="navbtn">â—€</button>
      <span id="pageLabel">1 / ?</span>
      <button id="nextBtn" class="navbtn">â–¶</button>
    </div>
  </footer>
</div>

<script src="js/pintura.js"></script>
<script src="js/script.js"></script>
<script src="js/patch-gestures-scroll.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const customBtn = document.getElementById("customColorBtn");
  const pickerBtn = document.getElementById("pickerBtn");
  const pickerInput = document.getElementById("colorPickerInput");
  let popup = null;

  const COLORS = [
    "#FF6F61","#F06292","#BA68C8","#9575CD","#4FC3F7","#4DD0E1",
    "#81C784","#AED581","#FFD54F","#FFB74D","#A1887F","#BDBDBD"
  ];

  function close() {
    if(!popup) return;
    popup.classList.remove("active");
    setTimeout(() => { if(popup) popup.remove(); popup = null; }, 200);
    customBtn.classList.remove("active");
    document.removeEventListener("mousedown", outside);
    document.removeEventListener("touchstart", outside);
  }

  function outside(e) {
    if(popup && !popup.contains(e.target) && e.target !== customBtn) close();
  }

  function open() {
    close();
    popup = document.createElement("div");
    popup.className = "palette-popup";
    
    COLORS.forEach(c => {
      const d = document.createElement("div");
      d.className = "extra-color";
      d.style.background = c;
      d.style.width = "40px";
      d.style.height = "40px";
      d.style.borderRadius = "50%";
      d.onclick = () => { window.setColor?.(c); close(); };
      popup.appendChild(d);
    });

    document.body.appendChild(popup);

    // FIX: CÃ¡lculo de centralizaÃ§Ã£o com travas de borda
    const r = customBtn.getBoundingClientRect();
    const popupWidth = 200; // Largura aproximada baseada no grid
    const screenWidth = window.innerWidth;

    let leftPos = r.left + (r.width / 2) - (popupWidth / 2);

    // NÃ£o deixa sair pela direita nem pela esquerda
    if (leftPos + popupWidth > screenWidth - 15) leftPos = screenWidth - popupWidth - 15;
    if (leftPos < 15) leftPos = 15;

    popup.style.left = leftPos + "px";
    popup.style.top = (r.top - 200) + "px"; // Ajuste manual ou auto

    // Ajuste fino de altura apÃ³s render
    requestAnimationFrame(() => {
        popup.style.top = (r.top - popup.offsetHeight - 12) + "px";
        popup.classList.add("active");
    });

    document.addEventListener("mousedown", outside);
    document.addEventListener("touchstart", outside);
  }

  customBtn.onclick = e => {
    e.stopPropagation();
    popup ? close() : open();
  };

  pickerBtn.onclick = () => pickerInput.click();
  pickerInput.oninput = e => { window.setColor?.(e.target.value); };
});
</script>

<script>
  // Monitora mudanÃ§as no SVG para garantir reset de posiÃ§Ã£o
  const mount = document.getElementById("svgMount");
  
  // FunÃ§Ã£o para resetar visualmente o SVG quando a escala for 1
  function resetSvgTransform() {
    const svg = mount.querySelector("svg");
    if (!svg) return;
    
    // Se seu script 'pintura.js' usa style.transform, nÃ³s resetamos o translate
    // Isso Ã© disparado se detectarmos que o usuÃ¡rio quer o estado original
    if (svg.style.transform.includes("scale(1)") || svg.style.transform === "") {
        svg.style.transform = "translate(0px, 0px) scale(1)";
    }
  }

  // Observer para esconder loading
  const overlay = document.getElementById("loadingOverlay");
  const obs = new MutationObserver(() => {
    if(document.querySelector("#svgMount svg")){
      setTimeout(() => {
          overlay.classList.add("hidden");
          resetSvgTransform();
      }, 400);
      obs.disconnect();
    }
  });
  obs.observe(mount, {childList:true, subtree:true});

  // Listener opcional: se o usuÃ¡rio clicar no pager, resetar zoom
  document.querySelectorAll('.navbtn').forEach(btn => {
      btn.addEventListener('click', () => {
          setTimeout(resetSvgTransform, 50);
      });
  });
</script>

</body>
</html>
