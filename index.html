<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Pintando a Palavra ‚Äî Colorir</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===== FIX 1: ESTRUTURA E ZOOM ISOLADO ===== */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; /* Impede que o navegador role a p√°gina toda */
      background: #fff9e6;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* O Stage agora ocupa todo o espa√ßo central sem esmagar o desenho */
    .stage {
      flex: 1;
      position: relative;
      overflow: hidden; 
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none; /* Bloqueia zoom nativo do browser apenas aqui */
      z-index: 1;
    }

    #svgMount {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Garante que o SVG n√£o seja cortado e mantenha propor√ß√£o */
    #svgMount svg {
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: auto;
    }

    /* UI Fixa */
    .topbar, .controls {
      position: relative;
      z-index: 10; /* Fica acima do stage */
      flex-shrink: 0; /* N√£o deixa a UI ser esmagada */
    }

    /* ===== FIX 2: POPUP RECALCULADO ===== */
    .palette-popup {
      position: fixed;
      z-index: 9999;
      background: #fff;
      padding: 12px;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      visibility: hidden;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }
    .palette-popup.active {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }
    .extra-color {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #eee;
      cursor: pointer;
    }

    /* ===== Loading ===== */
    #loadingOverlay{
      position:fixed;
      inset:0;
      background:#fff9e6;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:10000;
      transition:opacity .4s ease, visibility .4s ease;
    }
    #loadingOverlay.hidden{opacity:0;visibility:hidden}
    .spinner{
      width:60px;height:60px;
      border:6px solid #ffd54f;
      border-top:6px solid transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>üé® Carregando ilustra√ß√µes...</div>
</div>

<header class="topbar">
  <div id="progressWidget" class="progress-widget">
    <div class="counter">
      <span id="starCount">00</span>
      <span>/</span>
      <span id="totalPages">00</span>
      <span class="star-icon">‚òÖ</span>
      <span id="progressPercent">0%</span>
    </div>
    <div class="progressbar">
      <div class="track">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>
  </div>
</header>

<div class="app">
  <main class="stage">
    <div id="svgMount" class="svgMount"></div>
  </main>

  <footer class="controls">
    <div class="palette">
      <div class="swatches" id="swatches">
        <button class="sw" data-color="#E53935" style="--c:#E53935"></button>
        <button class="sw" data-color="#FB8C00" style="--c:#FB8C00"></button>
        <button class="sw" data-color="#FDD835" style="--c:#FDD835"></button>
        <button class="sw" data-color="#7CB342" style="--c:#7CB342"></button>
        <button class="sw" data-color="#42A5F5" style="--c:#42A5F5"></button>
        <button class="sw" data-color="#8E24AA" style="--c:#8E24AA"></button>
        <button class="sw" data-color="#E0C2A2" style="--c:#E0C2A2"></button>
        <button class="sw" data-color="#8D6E63" style="--c:#8D6E63"></button>

        <button class="sw custom-picker" id="pickerBtn">üé®</button>
        <input type="color" id="colorPickerInput" style="display:none">
        <button class="sw custom" id="customColorBtn">+</button>
      </div>
    </div>

    <div class="tools">
      <button id="eraserBtn" class="btn">Borracha</button>
      <button id="undoBtn" class="btn">Desfazer</button>
      <button id="redoBtn" class="btn">Refazer</button>
      <button id="savePng" class="btn primary">Salvar</button>
    </div>

    <div class="pager">
      <button id="prevBtn" class="navbtn">‚óÄ</button>
      <span id="pageLabel">1 / ?</span>
      <button id="nextBtn" class="navbtn">‚ñ∂</button>
    </div>
  </footer>
</div>

<script src="js/pintura.js"></script>
<script src="js/script.js"></script>
<script src="js/patch-gestures-scroll.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const customBtn=document.getElementById("customColorBtn");
  const pickerBtn=document.getElementById("pickerBtn");
  const pickerInput=document.getElementById("colorPickerInput");
  let popup=null;

  const COLORS=[
    "#FF6F61","#F06292","#BA68C8","#9575CD","#4FC3F7","#4DD0E1",
    "#81C784","#AED581","#FFD54F","#FFB74D","#A1887F","#BDBDBD"
  ];

  function close(){
    if(!popup)return;
    popup.classList.remove("active");
    setTimeout(()=> { if(popup) { popup.remove(); popup=null; } }, 200);
    customBtn.classList.remove("active");
    document.removeEventListener("click",outside);
  }

  function outside(e){
    if(popup&&!popup.contains(e.target)&&e.target!==customBtn)close();
  }

  function open(){
    close();
    popup=document.createElement("div");
    popup.className="palette-popup";
    COLORS.forEach(c=>{
      const d=document.createElement("div");
      d.className="extra-color";
      d.style.background=c;
      d.onclick=()=>{
        window.setColor?.(c);
        close();
      };
      popup.appendChild(d);
    });
    document.body.appendChild(popup);

    // FIX: POSICIONAMENTO DIN√ÇMICO
    const r=customBtn.getBoundingClientRect();
    const popupWidth = 210; // Largura aproximada do grid
    let left = r.left + (r.width/2) - (popupWidth/2);
    
    // Ajuste para n√£o sair da tela
    if(left < 10) left = 10;
    if(left + popupWidth > window.innerWidth) left = window.innerWidth - popupWidth - 10;

    popup.style.left = left + "px";
    
    // Posiciona acima do bot√£o
    requestAnimationFrame(()=>{
      popup.style.top = (r.top - popup.offsetHeight - 10) + "px";
      popup.classList.add("active");
    });

    setTimeout(()=> document.addEventListener("click",outside), 50);
  }

  customBtn.onclick=e=>{
    e.stopPropagation();
    popup?close():open();
  };

  pickerBtn.onclick=()=>pickerInput.click();
  pickerInput.oninput=e=>{
    window.setColor?.(e.target.value);
  };
});

// ===== FIX 3: RESET AUTOM√ÅTICO DO ZOOM =====
// Esta fun√ß√£o monitora se o zoom voltou ao normal e recentraliza o SVG
function autoResetSVG() {
  const svg = document.querySelector("#svgMount svg");
  if(!svg) return;

  // Se o seu script de zoom usa transform, verificamos a escala
  const style = window.getComputedStyle(svg);
  const matrix = new DOMMatrixReadOnly(style.transform);
  
  // Se a escala for 1 (ou muito pr√≥xima), resetamos a posi√ß√£o para o centro
  if (Math.abs(matrix.a - 1) < 0.01) {
    svg.style.transform = "translate(0px, 0px) scale(1)";
  }
}

// Executa o reset ao trocar de p√°gina
document.getElementById("prevBtn").addEventListener("click", () => setTimeout(autoResetSVG, 100));
document.getElementById("nextBtn").addEventListener("click", () => setTimeout(autoResetSVG, 100));

// Observer para esconder o loading
const overlay=document.getElementById("loadingOverlay");
const obs=new MutationObserver(()=>{
  if(document.querySelector("#svgMount svg")){
    setTimeout(()=>overlay.classList.add("hidden"),400);
    obs.disconnect();
  }
});
obs.observe(document.getElementById("svgMount"),{childList:true,subtree:true});
</script>

</body>
</html>
